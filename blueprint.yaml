#######
# Cloudify Blueprint which describes the nodecellar application
# https://github.com/ccoenraets/nodecellar
# Author: kemiz
#######
tosca_definitions_version: cloudify_dsl_1_0

imports:
    - http://www.getcloudify.org/spec/cloudify/3.1m5/types.yaml


################################################################
# Blueprint inputs
# 
# The values are provided via the inputs.json file.
# passed when creating the deployment (-i inputs.json).
################################################################
inputs:

    host_ip:
        description: >
            The ip of the host the application will be deployed on        

    agent_user:
        description: >
            User name used when SSH-ing into the started machine

    agent_private_key_path:
        description: >
            Path to a private key that resided on the management machine.
            SSH-ing into agent machines will be done with this key.


#################################################################
# Blueprint types
#
# Custom types for this blueprint.
#################################################################
node_types:

  docker_container:
    derived_from: cloudify.types.app_server

  docker_app:
    derived_from: cloudify.types.app_module
    properties:

      app_name:
        description: Application name
        type: string

      git_url:
        description: Web application git url
        type: string

      git_branch:
        description: git branch
        type: string

      base_port:
        description: Web application port
        type: integer


#################################################################
# Blueprint relationships
#
# Custom relatioships for this blueprint.
#################################################################
# relationships:

#     # Used for passing mongo environment variables 
#     # to the nodejs application
#     nodecellar_connected_to_mongo:
#         derived_from: cloudify.relationships.connected_to
#         source_interfaces:
#             cloudify.interfaces.relationship_lifecycle:
#                   postconfigure: 
#                       implementation: nodecellar-scripts/postconfigure.py


##################################################################
# Blueprint node_templates
#
# These are the actual blueprint nodes.
##################################################################
node_templates:

    # Server to host both mongo and node
    vm:
        type: cloudify.types.host
        properties:
            ip: { get_input: host_ip }
            cloudify_agent:
                user: { get_input: agent_user }
                key: { get_input: agent_private_key_path }

    # docker
    docker_container:
        type: docker_container
        interfaces:
            cloudify.interfaces.lifecycle:                    
                  create: scripts/install-docker.sh
        relationships:
            - type: cloudify.relationships.contained_in
              target: vm

    # the actual nodejs application
    nodecellar_app:
        type: docker_app
        properties:
            app_name: nodecellar
            # dockerised nodecellar app
            git_url: https://github.com/kemiz/nodecellar.git
            git_branch: master
            base_port: 3000
        interfaces:
            cloudify.interfaces.lifecycle:            
                  create: 
                    implementation: scripts/install-app.sh
                    inputs:
                        process:
                            # this directory should already exist
                            cwd: /tmp/workdir
                            args:
                            env:
                                APP_NAME: { get_property: [ nodecellar_app, app_name ] }
                                APP_PORT: { get_property: [ nodecellar_app, base_port ] }                 
                  start:
                    implementation: scripts/start-app.sh
                    inputs:
                        process:
                            # this directory should already exist
                            cwd: /tmp/workdir
                            args: [arg1_value, arg2_value]
                            env:
                                MY_ENV_VARIABLE: MY_ENV_VARIABLE_VALUE
                  stop: 
                    implementation: scripts/stop-app.sh
                    inputs:
                        process:
                            # this directory should already exist
                            cwd: /tmp/workdir
                            args: [arg1_value, arg2_value]
                            env:
                                MY_ENV_VARIABLE: MY_ENV_VARIABLE_VALUE                  
        relationships:
            - type: cloudify.relationships.contained_in
              target: docker_container

######################################################################
# Blueprint outputs
#
# Accessible via 'cfy deployments outputs -d <deployment_id>'
######################################################################
outputs:

  # hit this endpoint to actually see the running application.
  endpoint:
    description: Web application endpoint
    value:
      ip_address: { get_input: host_ip }
      port: { get_property: [ nodecellar_app, base_port ] }
