#################################################################
# Cloudify Blueprint which describes the nodecellar application.
# see https://github.com/ccoenraets/nodecellar
#
#################################################################

tosca_definitions_version: cloudify_dsl_1_0

imports:
     -  http://www.getcloudify.org/spec/cloudify/3.0/types.yaml

plugins:
    nodecellar_config:
        executor: host_agent
        source: nodecellar-config-plugin

node_types:
    mongo_database:
        derived_from: cloudify.types.db_server
        properties:
            role: {}
        interfaces:
            cloudify.interfaces.lifecycle:
                create: mongo-scripts/install-mongo.sh
                start:
                    implementation: mongo-scripts/start-mongo.sh
                    inputs:
                        port:
                          description: >
                              The Mongo server port
                stop: mongo-scripts/stop-mongo.sh

    nodejs_server:
        derived_from: cloudify.types.app_server
        interfaces:
            cloudify.interfaces.lifecycle:
                create: nodejs-scripts/install-nodejs.sh

    nodejs_app:
        derived_from: cloudify.types.app_module
        interfaces:
            cloudify.interfaces.lifecycle:
                create:
                    implementation: nodejs-scripts/install-app.sh
                    inputs:
                        app_name:
                          description: >
                              The application name
                        git_url:
                          description: >
                              The application git url
                        git_branch:
                          description: >
                              The application branch
                start:
                    implementation: nodejs-scripts/start-app.sh
                    inputs:
                        base_port:
                          description: >
                              The application's port
                        env_file_path:
                          description: >
                              Extra environment variables.
                              These will sourced inside the script.
                          default: ''
                stop: nodejs-scripts/stop-app.sh

relationships:
    nodecellar_connected_to_mongo:
        derived_from: cloudify.relationships.connected_to
        source_interfaces:
            cloudify.interfaces.relationship_lifecycle:
                postconfigure: nodecellar_config.nodecellar_config_plugin.tasks.get_mongo_host_and_port
     
node_templates:
    nodejs_vm:
        type: cloudify.types.host
        properties:
            ip: 127.0.0.1
            cloudify_agent:
                key: /home/vagrant/.ssh/cloudify_private_key

    mongod_vm:
        type: cloudify.types.host
        properties:
            ip: 127.0.0.1
            cloudify_agent:
                key: /home/vagrant/.ssh/cloudify_private_key

    mongod:
        type: mongo_database
        interfaces:
            cloudify.interfaces.lifecycle:
                start:
                    inputs:
                        port: 27017
        properties:
            role: mongod
        relationships:
            -   target: mongod_vm
                type: cloudify.relationships.contained_in

    nodejs:
        type: nodejs_server
        properties:
        relationships:
            -   type: cloudify.relationships.contained_in
                target: nodejs_vm

    nodecellar_app:
        type: nodejs_app
        cloudify.interfaces.lifecycle:
            create:
                inputs:
                    app_name: nodecellar
                    git_url: https://github.com/uric/nodecellar.git
                    git_branch: master
            start:
                inputs:
                    base_port: 8080
        relationships:
            -   type: cloudify.relationships.contained_in
                target: nodejs
            -   type: nodecellar_connected_to_mongo
                target: mongod
